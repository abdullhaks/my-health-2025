# 1. Use an official Node.js runtime as a base image
FROM node:20-alpine AS builder

# 2. Set working directory inside container
WORKDIR /app

# 3. Copy only package.json and package-lock.json first (to leverage caching)
COPY package*.json ./

# 4. Install dependencies
RUN npm install

# 5. Copy the entire project
COPY . .

# 6. Build TypeScript -> JavaScript with increased memory
RUN NODE_OPTIONS="--max-old-space-size=4096" npm run build

# --------------------
# Production stage
# --------------------
FROM node:20-alpine AS runner

WORKDIR /app

# Copy only needed files from builder
COPY package*.json ./
RUN npm install --omit=dev

# Copy compiled code and other required files
COPY --from=builder /app/dist ./dist
COPY --from=builder /app/src/utils/images ./src/utils/images

# Expose app port
EXPOSE 3000

# Define environment
ENV NODE_ENV=production

# Start the application
CMD ["node", "dist/index.js"]